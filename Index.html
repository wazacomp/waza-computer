<!DOCTYPE html>
<html lang="id">
<head>
  <title>WAZA COMPUTER - Aplikasi Servis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#25d366">
  <meta name="description" content="Aplikasi Manajemen Servis WAZA COMPUTER">
  
  <!-- PWA Manifest -->
  <link rel="manifest" id="manifest">
  
  <!-- Include Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Include html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    /* ALL CSS CODE FROM PREVIOUS EXAMPLE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    :root {
      --primary-color: #25d366;
      --secondary-color: #128C7E;
      --background-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-color: #333;
      --shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    body {
      background: var(--background-color);
      padding: 15px;
      color: var(--text-color);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .app-container {
      max-width: 100%;
      margin: 0 auto;
      position: relative;
    }
    
    /* ... (ALL OTHER CSS RULES FROM PREVIOUS EXAMPLE) ... */
  </style>
</head>
<body>
<div class="app-container">
    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt">
        <span>Install WAZA COMPUTER App?</span>
        <button onclick="installApp()">Install</button>
    </div>

    <div class="header">
        <h1><i class="fas fa-laptop-code"></i> WAZA COMPUTER</h1>
        <div class="address"><i class="fas fa-map-marker-alt"></i> Jl. Jend. Sudirman Lr. Kasuari Samping Kantor KPU Pal 1</div>
        <div class="address">Muara Bulian Batanghari Jambi</div>
        <div class="contact"><i class="fas fa-phone"></i> 085184266873 / 085769875515</div>
        <div class="email"><i class="fas fa-envelope"></i> wazacomputerbulian@gmail.com</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('dashboard')">
            <i class="fas fa-chart-line"></i> Dashboard
        </div>
        <div class="tab" onclick="showTab('input')">
            <i class="fas fa-plus-circle"></i> Input Data
        </div>
        <div class="tab" onclick="showTab('data')">
            <i class="fas fa-list"></i> Data Servis
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="tab-content">
        <div id="notification-area"></div>
        <div id="warranty-notification-area"></div>

        <div class="stats">
            <div class="stat-card in-progress" onclick="showServiceDetails('progress')">
                <div class="stat-number" id="count-progress">0</div>
                <div class="stat-label">Dalam Pengerjaan</div>
            </div>
            <div class="stat-card completed" onclick="showServiceDetails('completed')">
                <div class="stat-number" id="count-completed">0</div>
                <div class="stat-label">Selesai</div>
            </div>
            <div class="stat-card taken" onclick="showServiceDetails('taken')">
                <div class="stat-number" id="count-taken">0</div>
                <div class="stat-label">Sudah Diambil</div>
            </div>
        </div>

        <div id="service-details"></div>
    </div>

    <!-- Input Data -->
    <div id="input" class="tab-content hidden">
        <div class="card">
            <h3><i class="fas fa-plus-circle"></i> Input Data Servis Baru</h3>
            <input type="text" id="nama" placeholder="üë§ Nama Konsumen" required>
            <input type="tel" id="telpon" placeholder="üìû No. Telepon" required>
            <textarea id="alamat" placeholder="üè† Alamat Lengkap" required></textarea>
            <input type="text" id="merek" placeholder="üíª Merek Laptop" required>

            <label style="display: block; margin: 15px 0 8px 0; font-weight: bold;">
                <i class="fas fa-laptop"></i> Jenis/Model:
            </label>
            <select id="jenis" required>
                <option value="">- Pilih Jenis/Model --</option>
                <option value="Laptop">üíª Laptop</option>
                <option value="Macbook">üçé Macbook</option>
                <option value="PC">üñ•Ô∏è PC</option>
                <option value="Printer">üñ®Ô∏è Printer</option>
                <option value="Monitor">üì∫ Monitor</option>
                <option value="Elektronik lainnya">‚ö° Elektronik lainnya</option>
            </select>

            <textarea id="keluhan" placeholder="üîß Keluhan/Kerusakan" required></textarea>

            <label style="display: block; margin: 15px 0 8px 0; font-weight: bold;">
                <i class="fas fa-clipboard-check"></i> Kelengkapan:
            </label>
            <textarea id="kelengkapan" placeholder="üì¶ Contoh: Laptop + Charger + Tas"></textarea>

            <label style="display: block; margin: 15px 0 8px 0; font-weight: bold;">
                <i class="fas fa-calendar-alt"></i> Tanggal Masuk:
            </label>
            <input type="date" id="tanggal-masuk" required>
            
            <button onclick="tambahData()" class="success">
                <i class="fas fa-save"></i> Simpan Data Servis
            </button>
        </div>
    </div>

    <!-- Data Servis -->
    <div id="data" class="tab-content hidden">
        <div class="search-box card">
            <input type="text" id="search" placeholder="üîç Cari berdasarkan nama, merek, atau keluhan..."
                   onkeyup="filterData()" style="margin: 0;">
        </div>

        <div class="card">
            <h3><i class="fas fa-list"></i> Semua Data Servisan</h3>
            <div id="data-list">
                <p style="text-align: center; padding: 30px; color: #6b7280;">
                    <i class="fas fa-inbox" style="font-size: 36px; margin-bottom: 10px; opacity: 0.5;"></i><br>
                    Tidak ada data servis.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal Invoice -->
    <div id="invoiceModal" class="invoice-modal">
        <div class="invoice-content">
            <div class="invoice-company-header header">
                <h2><i class="fas fa-laptop-code"></i> WAZA COMPUTER</h2>
                <div class="address">Jl. Jend. Sudirman Lr. Kasuari Samping Kantor KPU Pal 1</div>
                <div class="address">Muara Bulian Batanghari Jambi</div>
                <div class="contact">üìû 085184266873 / 085769875515</div>
                <div class="email">üìß wazacomputerbulian@gmail.com</div>
            </div>

            <div class="invoice-header">
                <h3>üìÑ INVOICE SERVIS</h3>
            </div>

            <div class="invoice-details" id="invoiceDetails"></div>
            
            <div class="modal-buttons">
                <button onclick="generatePDF('print')" class="success">
                    <i class="fas fa-print"></i> Print
                </button>
                <button onclick="generatePDF('download')" class="warning">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button onclick="closeInvoice()" class="danger">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// PWA Functionality
let deferredPrompt;

// Create manifest dynamically
const manifest = {
  "name": "WAZA COMPUTER",
  "short_name": "WAZA COMPUTER", 
  "description": "Aplikasi Manajemen Servis WAZA COMPUTER",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#667eea",
  "theme_color": "#25d366",
  "orientation": "portrait",
  "icons": [
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíª</text></svg>",
      "sizes": "192x192",
      "type": "image/svg+xml"
    }
  ]
};

// Set manifest
document.getElementById('manifest').setAttribute('href', 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest)));

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    setTimeout(() => {
        document.getElementById('installPrompt').style.display = 'flex';
    }, 3000);
});

function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                document.getElementById('installPrompt').style.display = 'none';
            }
            deferredPrompt = null;
        });
    }
}

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Register service worker with inline code
        const swCode = `
            const CACHE_NAME = 'waza-computer-v1';
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open(CACHE_NAME).then((cache) => {
                        return cache.addAll(['./']);
                    })
                );
            });
            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request).then((response) => {
                        return response || fetch(event.request);
                    })
                );
            });
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swURL)
            .then((registration) => {
                console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// App Data Management
let dataServis = JSON.parse(localStorage.getItem('servisData')) || [];
let currentInvoiceData = null;
let currentActiveStat = null;

const warrantyOptions = [
    'Tidak ada garansi', '1 minggu', '2 minggu', '3 minggu', '4 minggu',
    '5 minggu', '6 minggu', '7 minggu', '8 minggu'
];

// Tab Navigation
function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');

    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    document.getElementById(tabName).classList.remove('hidden');

    if(tabName === 'dashboard') {
        updateDashboard();
        showNotifications();
        showWarrantyNotifications();
        document.getElementById('service-details').innerHTML = "";
        resetActiveStat();
    }
    if(tabName === 'data') renderDataList();
}

function resetActiveStat() {
    document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
    currentActiveStat = null;
}

// Service Details
function showServiceDetails(status) {
    const serviceDetails = document.getElementById('service-details');
    const services = dataServis.filter(item => item.status === status);

    resetActiveStat();
    event.currentTarget.classList.add('active');
    currentActiveStat = status;

    if (services.length === 0) {
        serviceDetails.innerHTML = `
            <div class="card">
                <h3><i class="fas fa-${getStatusIcon(status)}"></i> ${getStatusText(status)}</h3>
                <p style="text-align: center; padding: 30px; color: #6b7280;">
                    Tidak ada data servis dengan status ${getStatusText(status).toLowerCase()}.
                </p>
            </div>
        `;
        return;
    }

    serviceDetails.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-${getStatusIcon(status)}"></i> ${getStatusText(status)} (${services.length} data)</h3>
            <div class="service-detail-content">
                ${services.map(item => {
                    const daysInService = calculateDaysInService(item.tanggalMasuk);
                    const warrantyStatus = item.status === 'taken' ? getWarrantyStatus(item) : null;
                    const isOverdue = daysInService >= 3 && item.status === 'progress';
                    return `
                        <div class="service-item ${isOverdue ? 'service-item-overdue' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <strong>${item.nama}</strong>
                                    ${isOverdue ? `<span style="background: #ef4444; color: white; padding: 3px 10px; border-radius: 10px; font-size: 10px; margin-left: 6px;">
                                        <i class="fas fa-exclamation-triangle"></i> ${daysInService} hari
                                    </span>` : ''}
                                    ${warrantyStatus && warrantyStatus.status !== 'none' ? 
                                        `<span class="warranty-badge ${warrantyStatus.status === 'active' ? 'warranty-active' : 'warranty-expired'}" style="margin-left: 6px;">
                                            <i class="fas fa-${warrantyStatus.status === 'active' ? 'shield-alt' : 'exclamation-triangle'}"></i>
                                            ${warrantyStatus.text}
                                        </span>` : ''}
                                </div>
                            </div>
                            <div style="color: #6b7280; font-size: 13px; margin: 4px 0;">
                                <i class="fas fa-phone"></i> ${item.telpon}
                            </div>
                            <div style="color: #6b7280; font-size: 13px; margin: 4px 0;">
                                <i class="fas fa-laptop"></i> ${item.merek} - ${item.jenis}
                            </div>
                            <div style="font-size: 13px; margin: 6px 0;">
                                <strong><i class="fas fa-tools"></i> Keluhan:</strong> ${item.keluhan}
                            </div>
                            ${item.kelengkapan ? `<div style="font-size: 13px; margin: 6px 0;">
                                <strong><i class="fas fa-clipboard-check"></i> Kelengkapan:</strong> ${item.kelengkapan}
                            </div>` : ''}
                            <div style="font-size: 11px; color: #9ca3af; margin: 6px 0;">
                                <i class="fas fa-calendar-alt"></i> Masuk: ${formatDate(item.tanggalMasuk)} (${daysInService} hari)
                            </div>
                            ${item.status === 'taken' && item.totalBiaya ? 
                                `<div style="font-size: 13px; margin: 4px 0;">
                                    <strong><i class="fas fa-money-bill-wave"></i> Total Biaya:</strong> Rp ${item.totalBiaya.toLocaleString('id-ID')}
                                </div>` : ''}
                            ${item.status === 'taken' && item.garansi ? 
                                `<div style="font-size: 13px; margin: 4px 0;">
                                    <strong><i class="fas fa-shield-alt"></i> Garansi:</strong> ${item.garansi}
                                </div>` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

// Notifications
function showNotifications() {
    const notificationArea = document.getElementById('notification-area');
    const today = new Date();
    const overdueServices = dataServis.filter(service => {
        if (service.status !== 'progress') return false;
        const masukDate = new Date(service.tanggalMasuk);
        const diffDays = Math.ceil((today - masukDate) / (1000 * 60 * 60 * 24));
        return diffDays >= 3;
    });

    notificationArea.innerHTML = overdueServices.length === 0 ? '' : `
        <div class="notification">
            <div class="notification-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="notification-content">
                <div class="notification-title">Peringatan Servisan Lama</div>
                <div class="notification-desc">
                    Ada ${overdueServices.length} servisan yang sudah lebih dari 3 hari belum selesai.
                </div>
            </div>
        </div>
    `;
}

function showWarrantyNotifications() {
    const warrantyArea = document.getElementById('warranty-notification-area');
    const today = new Date();
    const expiredWarrantyServices = dataServis.filter(service => {
        if (service.status !== 'taken' || !service.tanggalDiambil || !service.garansi) return false;
        if (service.garansi === 'Tidak ada garansi') return false;

        const diambilDate = new Date(service.tanggalDiambil);
        const weeks = parseInt(service.garansi);
        const warrantyEndDate = new Date(diambilDate);
        warrantyEndDate.setDate(diambilDate.getDate() + (weeks * 7));

        return today > warrantyEndDate;
    });

    warrantyArea.innerHTML = expiredWarrantyServices.length === 0 ? '' : `
        <div class="notification warranty">
            <div class="notification-icon"><i class="fas fa-exclamation-circle"></i></div>
            <div class="notification-content">
                <div class="notification-title">Masa Garansi Habis</div>
                <div class="notification-desc">
                    Ada ${expiredWarrantyServices.length} servisan yang masa garansinya sudah habis.
                </div>
            </div>
        </div>
    `;
}

// Data Management Functions
function updateDashboard() {
    const progress = dataServis.filter(item => item.status === 'progress').length;
    const completed = dataServis.filter(item => item.status === 'completed').length;
    const taken = dataServis.filter(item => item.status === 'taken').length;

    document.getElementById('count-progress').textContent = progress;
    document.getElementById('count-completed').textContent = completed;
    document.getElementById('count-taken').textContent = taken;
}

function renderDataList() {
    const dataList = document.getElementById('data-list');

    if(dataServis.length === 0) {
        dataList.innerHTML = `
            <p style="text-align: center; padding: 30px; color: #6b7280;">
                <i class="fas fa-inbox" style="font-size: 36px; margin-bottom: 10px; opacity: 0.5;"></i><br>
                Tidak ada data servis.
            </p>
        `;
        return;
    }

    dataList.innerHTML = dataServis.map(item => {
        const daysInService = calculateDaysInService(item.tanggalMasuk);
        const isOverdue = daysInService >= 3 && item.status === 'progress';
        const warrantyStatus = item.status === 'taken' ? getWarrantyStatus(item) : null;

        return `
            <div class="service-item ${isOverdue ? 'service-item-overdue' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <strong>${item.nama}</strong>
                        ${isOverdue ? `<span style="background: #ef4444; color: white; padding: 3px 10px; border-radius: 10px; font-size: 10px; margin-left: 6px;">
                            <i class="fas fa-exclamation-triangle"></i> ${daysInService} hari
                        </span>` : ''}
                        ${warrantyStatus && warrantyStatus.status !== 'none' ? 
                            `<span class="warranty-badge ${warrantyStatus.status === 'active' ? 'warranty-active' : 'warranty-expired'}" style="margin-left: 6px;">
                                <i class="fas fa-${warrantyStatus.status === 'active' ? 'shield-alt' : 'exclamation-triangle'}"></i>
                                ${warrantyStatus.text}
                            </span>` : ''}
                    </div>
                    <span class="status-badge ${getStatusClass(item.status)}">
                        <i class="fas fa-${getStatusIcon(item.status)}"></i> ${getStatusText(item.status)}
                    </span>
                </div>
                <div style="color: #6b7280; font-size: 13px; margin: 4px 0;">
                    <i class="fas fa-phone"></i> ${item.telpon}
                </div>
                <div style="color: #6b7280; font-size: 13px; margin: 4px 0;">
                    <i class="fas fa-laptop"></i> ${item.merek} - ${item.jenis}
                </div>
                <div style="font-size: 13px; margin: 6px 0;">
                    <strong><i class="fas fa-tools"></i> Keluhan:</strong> ${item.keluhan}
                </div>
                ${item.kelengkapan ? `<div style="font-size: 13px; margin: 6px 0;">
                    <strong><i class="fas fa-clipboard-check"></i> Kelengkapan:</strong> ${item.kelengkapan}
                </div>` : ''}
                <div style="font-size: 11px; color: #9ca3af; margin: 6px 0;">
                    <i class="fas fa-calendar-alt"></i> ${formatDate(item.tanggalMasuk)} (${daysInService} hari)
                </div>
                ${item.status === 'taken' ? 
                    `<div style="font-size: 11px; color: #9ca3af; margin: 4px 0;">
                        <i class="fas fa-calendar-check"></i> Diambil: ${formatDate(item.tanggalDiambil)}
                    </div>` : ''}

                <div class="action-buttons">
                    ${item.status === 'progress' ? 
                        `<button class="action-btn success" onclick="ubahStatus(${item.id}, 'completed')">
                            <i class="fas fa-check-circle"></i> Selesai
                        </button>` : ''}
                    ${item.status === 'completed' ? 
                        `<button class="action-btn danger" onclick="ubahStatus(${item.id}, 'taken')">
                            <i class="fas fa-hand-holding"></i> Sudah Diambil
                        </button>` : ''}
                    ${item.status === 'taken' ? 
                        `<button class="action-btn warning" onclick="showInvoice(${item.id})">
                            <i class="fas fa-file-invoice"></i> Invoice
                        </button>` : ''}
                    <button class="action-btn secondary" onclick="hapusData(${item.id})">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Core Business Logic
function tambahData() {
    const nama = document.getElementById('nama').value.trim();
    const telpon = document.getElementById('telpon').value.trim();
    const alamat = document.getElementById('alamat').value.trim();
    const merek = document.getElementById('merek').value.trim();
    const jenis = document.getElementById('jenis').value;
    const keluhan = document.getElementById('keluhan').value.trim();
    const kelengkapan = document.getElementById('kelengkapan').value.trim();
    const tanggalMasuk = document.getElementById('tanggal-masuk').value;

    if(!nama || !telpon || !alamat || !merek || !jenis || !keluhan) {
        alert('‚ùå Harap isi semua field yang wajib!');
        return;
    }

    const newData = {
        id: Date.now(),
        nama, telpon, alamat, merek, jenis, keluhan, kelengkapan, tanggalMasuk,
        status: 'progress',
        biayaServis: 0, biayaParts: 0, totalBiaya: 0,
        garansi: 'Tidak ada garansi'
    };

    dataServis.push(newData);
    localStorage.setItem('servisData', JSON.stringify(dataServis));

    // Reset form
    ['nama','telpon','alamat','merek','keluhan','kelengkapan'].forEach(id => 
        document.getElementById(id).value = "");
    document.getElementById('jenis').value = "";
    document.getElementById('tanggal-masuk').value = new Date().toISOString().split('T')[0];

    alert('‚úÖ Data servis berhasil disimpan!');
    showTab('dashboard');
}

function ubahStatus(id, statusBaru) {
    if (statusBaru === 'taken') {
        const biayaServis = prompt('Masukkan biaya servis:', '0');
        const biayaParts = prompt('Masukkan biaya parts/sparepart:', '0');

        if (biayaServis === null || biayaParts === null) return;

        let garansiOptions = 'Pilih masa garansi:\n';
        warrantyOptions.forEach((option, index) => {
            garansiOptions += `${index}. ${option}\n`;
        });

        const garansiIndex = prompt(garansiOptions + '\nMasukkan nomor pilihan (0-8)', '0');
        if (garansiIndex === null) return;

        const selectedGaransi = warrantyOptions[parseInt(garansiIndex)] || 'Tidak ada garansi';

        dataServis = dataServis.map(item => {
            if(item.id === id) {
                return {
                    ...item,
                    status: statusBaru,
                    biayaServis: parseInt(biayaServis) || 0,
                    biayaParts: parseInt(biayaParts) || 0,
                    totalBiaya: (parseInt(biayaServis) || 0) + (parseInt(biayaParts) || 0),
                    tanggalDiambil: new Date().toISOString().split('T')[0],
                    garansi: selectedGaransi
                };
            }
            return item;
        });

    } else {
        dataServis = dataServis.map(item => {
            if(item.id === id) return {...item, status: statusBaru};
            return item;
        });
    }

    localStorage.setItem('servisData', JSON.stringify(dataServis));
    renderDataList();
    updateDashboard();
    if (currentActiveStat) showServiceDetails(currentActiveStat);
    alert('‚úÖ Status berhasil diubah!');
}

function hapusData(id) {
    if(confirm('‚ö†Ô∏è Apakah Anda yakin ingin menghapus data ini?')) {
        dataServis = dataServis.filter(item => item.id !== id);
        localStorage.setItem('servisData', JSON.stringify(dataServis));
        renderDataList();
        updateDashboard();
        if (currentActiveStat) showServiceDetails(currentActiveStat);
        alert('‚úÖ Data berhasil dihapus!');
    }
}

function filterData() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    const filteredData = dataServis.filter(item =>
        item.nama.toLowerCase().includes(searchTerm) ||
        item.merek.toLowerCase().includes(searchTerm) ||
        item.keluhan.toLowerCase().includes(searchTerm)
    );

    const dataList = document.getElementById('data-list');
    
    if(filteredData.length === 0) {
        dataList.innerHTML = `
            <p style="text-align: center; padding: 30px; color: #6b7280;">
                <i class="fas fa-search" style="font-size: 36px; margin-bottom: 10px; opacity: 0.5;"></i><br>
                Tidak ada data yang sesuai dengan pencarian.
            </p>
        `;
        return;
    }

    dataList.innerHTML = filteredData.map(item => {
        const daysInService = calculateDaysInService(item.tanggalMasuk);
        const isOverdue = daysInService >= 3 && item.status === 'progress';
        const warrantyStatus = item.status === 'taken' ? getWarrantyStatus(item) : null;

        return `
            <div class="service-item ${isOverdue ? 'service-item-overdue' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <strong>${item.nama}</strong>
                        ${isOverdue ? `<span style="background: #ef4444; color: white; padding: 3px 10px; border-radius: 10px; font-size: 10px; margin-left: 6px;">
                            <i class="fas fa-exclamation-triangle"></i> ${daysInService} hari
                        </span>` : ''}
                        ${warrantyStatus && warrantyStatus.status !== 'none' ? 
                            `<span class="warranty-badge ${warrantyStatus.status === 'active' ? 'warranty-active' : 'warranty-expired'}" style="margin-left: 6px;">
                                <i class="fas fa-${warrantyStatus.status === 'active' ? 'shield-alt' : 'exclamation-triangle'}"></i>
                                ${warrantyStatus.text}
                            </span>` : ''}
                    </div>
                    <span class="status-badge ${getStatusClass(item.status)}">
                        <i class="fas fa-${getStatusIcon(item.status)}"></i> ${getStatusText(item.status)}
                    </span>
                </div>
                <div style="color: #6b7280; font-size: 13px; margin: 4px 0;">
                    <i class="fas fa-phone"></i> ${item.telpon}
                </div>
                <div style="color: #6b7280; font-size: 13px; margin: 4px 0;">
                    <i class="fas fa-laptop"></i> ${item.merek} - ${item.jenis}
                </div>
                <div style="font-size: 13px; margin: 6px 0;">
                    <strong><i class="fas fa-tools"></i> Keluhan:</strong> ${item.keluhan}
                </div>
                ${item.kelengkapan ? `<div style="font-size: 13px; margin: 6px 0;">
                    <strong><i class="fas fa-clipboard-check"></i> Kelengkapan:</strong> ${item.kelengkapan}
                </div>` : ''}
                <div style="font-size: 11px; color: #9ca3af; margin: 6px 0;">
                    <i class="fas fa-calendar-alt"></i> ${formatDate(item.tanggalMasuk)} (${daysInService} hari)
                </div>
                ${item.status === 'taken' ? 
                    `<div style="font-size: 11px; color: #9ca3af; margin: 4px 0;">
                        <i class="fas fa-calendar-check"></i> Diambil: ${formatDate(item.tanggalDiambil)}
                    </div>` : ''}

                <div class="action-buttons">
                    ${item.status === 'progress' ? 
                        `<button class="action-btn success" onclick="ubahStatus(${item.id}, 'completed')">
                            <i class="fas fa-check-circle"></i> Selesai
                        </button>` : ''}
                    ${item.status === 'completed' ? 
                        `<button class="action-btn danger" onclick="ubahStatus(${item.id}, 'taken')">
                            <i class="fas fa-hand-holding"></i> Sudah Diambil
                        </button>` : ''}
                    ${item.status === 'taken' ? 
                        `<button class="action-btn warning" onclick="showInvoice(${item.id})">
                            <i class="fas fa-file-invoice"></i> Invoice
                        </button>` : ''}
                    <button class="action-btn secondary" onclick="hapusData(${item.id})">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Invoice Functions
function showInvoice(id) {
    const service = dataServis.find(item => item.id === id);
    if (!service) return;

    currentInvoiceData = service;

    const invoiceDetails = document.getElementById('invoiceDetails');
    invoiceDetails.innerHTML = `
        <div class="invoice-row">
            <strong>No. Invoice:</strong>
            <span>INV-${service.id}</span>
        </div>
        <div class="invoice-row">
            <strong>Tanggal:</strong>
            <span>${formatDate(service.tanggalDiambil || new Date().toISOString().split('T')[0])}</span>
        </div>
        <div class="invoice-row">
            <strong>Nama Pelanggan:</strong>
            <span>${service.nama}</span>
        </div>
        <div class="invoice-row">
            <strong>Telepon:</strong>
            <span>${service.telpon}</span>
        </div>
        <div class="invoice-row">
            <strong>Alamat:</strong>
            <span>${service.alamat}</span>
        </div>
        <div class="invoice-row">
            <strong>Merek/Jenis:</strong>
            <span>${service.merek} - ${service.jenis}</span>
        </div>
        <div class="invoice-row">
            <strong>Keluhan:</strong>
            <span>${service.keluhan}</span>
        </div>
        <div class="invoice-row">
            <strong>Kelengkapan:</strong>
            <span>${service.kelengkapan || '-'}</span>
        </div>
        <div class="invoice-row">
            <strong>Biaya Servis:</strong>
            <span>Rp ${(service.biayaServis || 0).toLocaleString('id-ID')}</span>
        </div>
        <div class="invoice-row">
            <strong>Biaya Parts:</strong>
            <span>Rp ${(service.biayaParts || 0).toLocaleString('id-ID')}</span>
        </div>
        <div class="invoice-row">
            <strong>Garansi:</strong>
            <span>${service.garansi || 'Tidak ada garansi'}</span>
        </div>
        <div class="invoice-row" style="border-top: 2px solid #25d366; font-weight: bold; padding-top: 12px;">
            <strong>TOTAL:</strong>
            <span>Rp ${(service.totalBiaya || 0).toLocaleString('id-ID')}</span>
        </div>
    `;

    document.getElementById('invoiceModal').style.display = 'flex';
}

function closeInvoice() {
    document.getElementById('invoiceModal').style.display = 'none';
}

function generatePDF(action) {
    if (!currentInvoiceData) return;

    const service = currentInvoiceData;
    const pdfContent = `
        <div class="invoice-pdf">
            <div class="company-header">
                <h2>WAZA COMPUTER</h2>
                <div>Jl. Jend. Sudirman Lr. Kasuari Samping Kantor KPU Pal 1</div>
                <div>Muara Bulian Batanghari Jambi</div>
                <div>Telp: 085184266873 / 085769875515</div>
                <div>Email: wazacomputerbulian@gmail.com</div>
            </div>

            <div class="invoice-title">
                <h3>INVOICE SERVIS LAPTOP</h3>
            </div>

            <div class="invoice-details">
                <div class="detail-row">
                    <strong>No. Invoice:</strong>
                    <span>INV-${service.id}</span>
                </div>
                <div class="detail-row">
                    <strong>Tanggal:</strong>
                    <span>${formatDate(service.tanggalDiambil || new Date().toISOString().split('T')[0])}</span>
                </div>
                <div class="detail-row">
                    <strong>Nama Pelanggan:</strong>
                    <span>${service.nama}</span>
                </div>
                <div class="detail-row">
                    <strong>Telepon:</strong>
                    <span>${service.telpon}</span>
                </div>
                <div class="detail-row">
                    <strong>Alamat:</strong>
                    <span>${service.alamat}</span>
                </div>
                <div class="detail-row">
                    <strong>Merek/Jenis:</strong>
                    <span>${service.merek} - ${service.jenis}</span>
                </div>
                <div class="detail-row">
                    <strong>Keluhan:</strong>
                    <span>${service.keluhan}</span>
                </div>
                <div class="detail-row">
                    <strong>Kelengkapan:</strong>
                    <span>${service.kelengkapan || '-'}</span>
                </div>
                <div class="detail-row">
                    <strong>Biaya Servis:</strong>
                    <span>Rp ${(service.biayaServis || 0).toLocaleString('id-ID')}</span>
                </div>
                <div class="detail-row">
                    <strong>Biaya Parts:</strong>
                    <span>Rp ${(service.biayaParts || 0).toLocaleString('id-ID')}</span>
                </div>
                <div class="detail-row">
                    <strong>Garansi:</strong>
                    <span>${service.garansi || 'Tidak ada garansi'}</span>
                </div>
                <div class="detail-row total-row">
                    <strong>TOTAL BIAYA:</strong>
                    <span>Rp ${(service.totalBiaya || 0).toLocaleString('id-ID')}</span>
                </div>
            </div>

            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div><strong>Teknisi WAZA COMPUTER</strong></div>
                </div>
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div><strong>Pelanggan</strong></div>
                </div>
            </div>

            <div style="margin-top: 30px; text-align: center; font-style: italic;">  
                <p>Terima kasih atas kepercayaan Anda kepada WAZA COMPUTER</p>
            </div>
        </div>
    `;

    const element = document.createElement('div');
    element.innerHTML = pdfContent;
    document.body.appendChild(element);

    const opt = {
        margin: 10,
        filename: `Invoice_WAZA_COMPUTER_${service.id}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    if (action === 'download') {
        html2pdf().set(opt).from(element).save().then(() => {
            document.body.removeChild(element);
            closeInvoice();
        });
    } else if (action === 'print') {
        html2pdf().set(opt).from(element).toPdf().get('pdf').then(function(pdf) {
            window.open(pdf.output('bloburi'), '_blank');
            document.body.removeChild(element);
            closeInvoice();
        });
    }
}

// Helper Functions
function calculateDaysInService(tanggalMasuk) {
    const today = new Date();
    const masukDate = new Date(tanggalMasuk);
    return Math.ceil((today - masukDate) / (1000 * 60 * 60 * 24));
}

function getWarrantyStatus(service) {
    if (!service.garansi || service.garansi === 'Tidak ada garansi') {
        return { status: 'none', text: 'Tidak ada garansi' };
    }

    const today = new Date();
    const diambilDate = new Date(service.tanggalDiambil);
    const weeks = parseInt(service.garansi);
    const warrantyEndDate = new Date(diambilDate);
    warrantyEndDate.setDate(diambilDate.getDate() + (weeks * 7));

    if (today > warrantyEndDate) {
        return { status: 'expired', text: 'Garansi habis' };
    } else {
        const diffDays = Math.ceil((warrantyEndDate - today) / (1000 * 60 * 60 * 24));
        return { status: 'active', text: `Garansi ${diffDays} hari lagi` };
    }
}

function getStatusClass(status) {
    const classes = { 'progress': 'status-progress', 'completed': 'status-completed', 'taken': 'status-taken' };
    return classes[status] || 'status-progress';
}

function getStatusIcon(status) {
    const icons = { 'progress': 'tools', 'completed': 'check-circle', 'taken': 'hand-holding' };
    return icons[status] || 'tools';
}

function getStatusText(status) {
    const texts = { 'progress': 'Dalam Pengerjaan', 'completed': 'Selesai', 'taken': 'Sudah Diambil' };
    return texts[status] || 'Dalam Pengerjaan';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

// Initialize App
document.getElementById('tanggal-masuk').value = new Date().toISOString().split('T')[0];
updateDashboard();
showNotifications();
showWarrantyNotifications();

// Prevent drag and drop for app-like experience
document.addEventListener('dragstart', (e) => e.preventDefault());
document.addEventListener('drop', (e) => e.preventDefault());
</script>
</body>
</html>
